{% extends "base.html" %}

{% block title %}Admin Dashboard - Parking Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-speedometer2 me-2"></i>Admin Dashboard</h1>
        <a href="{{ url_for('admin_create_lot') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-2"></i>Create Parking Lot
        </a>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3" data-aos="fade-up" data-aos-delay="100">
            <div class="stat-card glass-card h-100 position-relative overflow-hidden group-hover-effect" data-tilt>
                <div class="position-absolute top-0 end-0 p-3 opacity-25">
                    <i class="bi bi-building display-1 text-primary"></i>
                </div>
                <div class="stat-content p-2 position-relative z-1">
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-box bg-primary bg-opacity-10 p-3 rounded-circle me-3">
                            <i class="bi bi-building fs-3 text-primary"></i>
                        </div>
                        <h6 class="mb-0 text-muted text-uppercase fw-bold">Parking Lots</h6>
                    </div>
                    <div class="d-flex align-items-end">
                        <h2 class="display-4 fw-bold mb-0 text-primary">{{ stats.total_lots }}</h2>
                        <span
                            class="ms-2 mb-2 badge bg-primary bg-opacity-10 text-primary px-3 rounded-pill fw-medium">+
                            Active</span>
                    </div>
                    <p class="text-muted mt-3 mb-0 small">Total managed locations</p>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-primary" role="progressbar" style="width: 70%"></div>
                </div>
            </div>
        </div>

        <div class="col-md-3" data-aos="fade-up" data-aos-delay="200">
            <div class="stat-card glass-card h-100 position-relative overflow-hidden group-hover-effect" data-tilt>
                <div class="position-absolute top-0 end-0 p-3 opacity-25">
                    <i class="bi bi-aspect-ratio display-1 text-success"></i>
                </div>
                <div class="stat-content p-2 position-relative z-1">
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-box bg-success bg-opacity-10 p-3 rounded-circle me-3">
                            <i class="bi bi-aspect-ratio fs-3 text-success"></i>
                        </div>
                        <h6 class="mb-0 text-muted text-uppercase fw-bold">Total Spots</h6>
                    </div>
                    <div class="d-flex align-items-end">
                        <h2 class="display-4 fw-bold mb-0 text-success">{{ stats.total_spots }}</h2>
                        <span
                            class="ms-2 mb-2 badge bg-success bg-opacity-10 text-success px-3 rounded-pill fw-medium">Capacity</span>
                    </div>
                    <p class="text-muted mt-3 mb-0 small">Maximum vehicle capacity</p>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <div class="col-md-3" data-aos="fade-up" data-aos-delay="300">
            <div class="stat-card glass-card h-100 position-relative overflow-hidden group-hover-effect" data-tilt>
                <div class="position-absolute top-0 end-0 p-3 opacity-25">
                    <i class="bi bi-car-front-fill display-1 text-warning"></i>
                </div>
                <div class="stat-content p-2 position-relative z-1">
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-box bg-warning bg-opacity-10 p-3 rounded-circle me-3">
                            <i class="bi bi-car-front fs-3 text-warning"></i>
                        </div>
                        <h6 class="mb-0 text-muted text-uppercase fw-bold">Occupied</h6>
                    </div>
                    <div class="d-flex align-items-end">
                        <h2 class="display-4 fw-bold mb-0 text-warning">{{ stats.occupied_spots }}</h2>
                        <small class="ms-2 mb-2 text-muted fw-bold">/ {{ stats.total_spots }}</small>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <p class="text-muted mb-0 small">Current utilization</p>
                        <span class="text-warning fw-bold">{{ ((stats.occupied_spots / stats.total_spots * 100) if
                            stats.total_spots > 0 else 0) | round(1) }}%</span>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-warning" role="progressbar"
                        style="width: {{ (stats.occupied_spots / stats.total_spots * 100) if stats.total_spots > 0 else 0 }}%">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3" data-aos="fade-up" data-aos-delay="400">
            <div class="stat-card glass-card h-100 position-relative overflow-hidden group-hover-effect" data-tilt>
                <div class="position-absolute top-0 end-0 p-3 opacity-25">
                    <i class="bi bi-people-fill display-1 text-info"></i>
                </div>
                <div class="stat-content p-2 position-relative z-1">
                    <div class="d-flex align-items-center mb-3">
                        <div class="icon-box bg-info bg-opacity-10 p-3 rounded-circle me-3">
                            <i class="bi bi-people fs-3 text-info"></i>
                        </div>
                        <h6 class="mb-0 text-muted text-uppercase fw-bold">Users</h6>
                    </div>
                    <div class="d-flex align-items-end">
                        <h2 class="display-4 fw-bold mb-0 text-info">{{ stats.total_users }}</h2>
                        <span
                            class="ms-2 mb-2 badge bg-info bg-opacity-10 text-info px-3 rounded-pill fw-medium">Active</span>
                    </div>
                    <p class="text-muted mt-3 mb-0 small">Registered platform users</p>
                </div>
                <div class="progress mt-3" style="height: 4px;">
                    <div class="progress-bar bg-info" role="progressbar" style="width: 85%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row g-4 mb-5">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Parking Lot Occupancy</h5>
                </div>
                <div class="card-body">
                    <canvas id="occupancyChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-pie-chart me-2"></i>Overall Status</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Parking Lots Table -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-building me-2"></i>Parking Lots</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Location Name</th>
                            <th>Address</th>
                            <th>Price/Hour</th>
                            <th>Capacity</th>
                            <th>Available</th>
                            <th>Occupied</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lot in lots %}
                        <tr>
                            <td class="fw-semibold">{{ lot.prime_location_name }}</td>
                            <td>{{ lot.address }}, {{ lot.pin_code }}</td>
                            <td>${{ "%.2f"|format(lot.price_per_hour) }}</td>
                            <td>{{ lot.total_spots or 0 }}</td>
                            <td>
                                <span class="badge bg-success">{{ lot.available_spots or 0 }}</span>
                            </td>
                            <td>
                                <span class="badge bg-warning">{{ lot.occupied_spots or 0 }}</span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('admin_view_spots', lot_id=lot.id) }}"
                                        class="btn btn-outline-info btn-sm">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="{{ url_for('admin_edit_lot', lot_id=lot.id) }}"
                                        class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a href="{{ url_for('admin_delete_lot', lot_id=lot.id) }}"
                                        class="btn btn-outline-danger btn-sm"
                                        onclick="return confirm('Are you sure you want to delete this parking lot?')">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-clock-history me-2"></i>Recent Reservations</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Location</th>
                                    <th>Spot</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reservation in reservations[:10] %}
                                <tr>
                                    <td>{{ reservation.username }}</td>
                                    <td>{{ reservation.prime_location_name }}</td>
                                    <td>Spot {{ reservation.spot_number }}</td>
                                    <td>
                                        <span
                                            class="badge bg-{{ 'success' if reservation.status == 'active' else 'secondary' }}">
                                            {{ reservation.status|title }}
                                        </span>
                                    </td>
                                    <td>{{ reservation.parking_timestamp }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-people me-2"></i>User Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Total Users:</span>
                            <strong>{{ stats.total_users }}</strong>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Active Reservations:</span>
                            <strong>{{ stats.active_reservations }}</strong>
                        </div>
                    </div>
                    <hr>
                    <h6>Recent Registrations:</h6>
                    <div class="list-group list-group-flush">
                        {% for user in users[:5] %}
                        {% if user.role == 'user' %}
                        <div class="list-group-item border-0 px-0 py-1">
                            <small>{{ user.username }} - {{ user.created_at if user.created_at is string else
                                user.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Fetch chart data and render charts
    fetch('/api/admin/stats')
        .then(response => response.json())
        .then(data => {
            // Occupancy Chart
            const occupancyCtx = document.getElementById('occupancyChart').getContext('2d');
            new Chart(occupancyCtx, {
                type: 'bar',
                data: {
                    labels: data.lot_names,
                    datasets: [{
                        label: 'Occupied',
                        data: data.lot_occupancy,
                        backgroundColor: 'rgba(255, 193, 7, 0.8)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Capacity',
                        data: data.lot_capacity,
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Status Pie Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const totalOccupied = data.lot_occupancy.reduce((a, b) => a + b, 0);
            const totalCapacity = data.lot_capacity.reduce((a, b) => a + b, 0);
            const totalAvailable = totalCapacity - totalOccupied;

            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Available', 'Occupied'],
                    datasets: [{
                        data: [totalAvailable, totalOccupied],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        });
</script>
{% endblock %}